<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tom Savage">
<meta name="author" content="Antonio del Rio Chanona">
<meta name="dcterms.date" content="2023-10-27">
<meta name="keywords" content="Bayesian Optimisation, Expert Guided, Human-In-The-Loop, Batch">

<title>ΤΡΣ - Expert-guided Bayesian Optimisation for Human-in-the-loop Experimental Design of Known Systems</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">ΤΡΣ</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About Me</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/trsav" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/savage_tom" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Expert-guided Bayesian Optimisation for Human-in-the-loop Experimental Design of Known Systems</h1>
            <p class="subtitle lead">NeurIPS workshop on Modern Experimental Desisgn and Active Learning in the Real World</p>
                                <div class="quarto-categories">
                <div class="quarto-category">optimisation</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-heading">Affiliations</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author">Tom Savage <a href="https://orcid.org/0000-0001-8715-8369" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
    </div>
      <div class="quarto-title-meta-contents">
          <p class="affiliation">
              <a href="www.imperial.ac.uk/people/t.savage">
              Imperial College London
              </a>
            </p>
          <p class="affiliation">
              <a href="https://www.turing.ac.uk/people/enrichment-students/tom-savage">
              The Alan Turing Institute
              </a>
            </p>
        </div>
        <div class="quarto-title-meta-contents">
      <p class="author">Antonio del Rio Chanona </p>
    </div>
      </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 27, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#abstract" id="toc-abstract" class="nav-link active" data-scroll-target="#abstract">Abstract</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#previous-work" id="toc-previous-work" class="nav-link" data-scroll-target="#previous-work"><span class="header-section-number">2</span> Previous Work</a></li>
  <li><a href="#method" id="toc-method" class="nav-link" data-scroll-target="#method"><span class="header-section-number">3</span> Method</a></li>
  <li><a href="#computational-results-discussion" id="toc-computational-results-discussion" class="nav-link" data-scroll-target="#computational-results-discussion"><span class="header-section-number">4</span> Computational Results &amp; Discussion</a></li>
  <li><a href="#appendix-a-algorithm" id="toc-appendix-a-algorithm" class="nav-link" data-scroll-target="#appendix-a-algorithm">Appendix A (Algorithm)</a></li>
  <li><a href="#appendix-b-optimisation-details" id="toc-appendix-b-optimisation-details" class="nav-link" data-scroll-target="#appendix-b-optimisation-details">Appendix B (Optimisation Details)</a></li>
  <li><a href="#appendix-c.-regret-plots" id="toc-appendix-c.-regret-plots" class="nav-link" data-scroll-target="#appendix-c.-regret-plots">Appendix C. (Regret Plots)</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">




<section id="abstract" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="abstract">Abstract</h2>
<p>Domain experts often possess valuable physical insights that are overlooked in fully automated decision-making processes such as Bayesian optimisation. In this article we apply high-throughput (batch) Bayesian optimisation alongside anthropological decision theory to enable domain experts to influence the selection of optimal experiments. Our methodology exploits the hypothesis that humans are better at making discrete choices than continuous ones and enables experts to influence critical early decisions. At each iteration we solve an augmented multi-objective optimisation problem across a number of alternate solutions, maximising both the sum of their utility function values and the determinant of their covariance matrix, equivalent to their total variability. By taking the solution at the knee point of the Pareto front, we return a set of alternate solutions at each iteration that have both high utility values and are reasonably distinct, from which the expert selects one for evaluation. We demonstrate that even in the case of an uninformed practitioner, our algorithm recovers the regret of standard Bayesian optimisation.</p>
</section>
<section id="introduction" class="level2 page-columns page-full" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>Bayesian optimisation has been successfully applied in a number of complex domains including engineering systems where derivatives are often not available, such as those that involve simulation or propriety software. By removing the human from decision-making processes in favour of maximising statistical quantities such as expected improvement, complex functions can be optimised in an efficient number of samples. However, these engineering systems are often engaged with by domain experts such as engineers or chemists, and as such the behaviour of the underlying function cannot be considered completely unknown a-priori. Therefore, there exists significant scope to take advantage of the benefits of Bayesian optimisation in optimising expensive derivative-free problems, whilst enabling domain experts to inform the decision-making process, putting the human back into the loop. By providing an optimal set of alternatives to an expert to select their desired evaluation, we ensure that any one choice presents information gain about the optimal solution. Simultaneously, we ensure the choices are distinct enough to avoid the human making an effective gradient calculation. Alternative solution information such as utility function value, predictive output distribution and visualisations are provided to the expert as a pseudo-likelihood. The decision-maker then effectively performs discrete Bayesian reasoning, internally conditioning the provided information with their own prior expertise and knowledge of the solutions provided. In addition to improved convergence (depending on the ability of the domain expert), our methodology enables improved interpretability in higher dimensions, as the decision-maker has the final say in what is evaluated. Our approach works with any utility function and NSGA-II <span class="citation" data-cites="Deb2002">(<a href="#ref-Deb2002" role="doc-biblioref">Deb et al. 2002</a>)</span> is applied for multi-objective optimisation, efficiently handling the non-convex utility-space.<br>
<a href="#fig-overview">Figure&nbsp;1</a> demonstrates our methodology</p>
<div class="no-row-height column-margin column-container"></div><div id="fig-overview" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="overview_figure.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;1: Overview of our methodology, where an augmented batch Bayesian optimisation problem is solved using multi-objective optimisation, providing an expert with a set of alternate solutions.</figcaption>
</figure>
</div>
<p>By allowing an expert to influence the experimental design through a discrete decision step, we mitigate the expert needing to make continuous decisions throughout, and do not rely on an expert `prior’ of the global optimum that necessarily must be defined before optimisation. Approaches that rely on an expert-defined prior may need to redefine this at significant human-cost throughout optimisation in light of new information. Similarly, the expert has no influence over the actual solutions evaluated and the optimisation is merely weighted towards broad regions in solution-space.</p>
</section>
<section id="previous-work" class="level2 page-columns page-full" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="previous-work"><span class="header-section-number">2</span> Previous Work</h2>
<p><span class="citation" data-cites="Kanarik2023">(<a href="#ref-Kanarik2023" role="doc-biblioref">Kanarik et al. 2023</a>)</span> demonstrated that experts improve the initial convergence in Bayesian optimisation for semiconductor processes. However, this can be counterproductive in later stages. Algorithmic integration of expert knowledge has been explored <span class="citation" data-cites="Liu2022">Hvarfner et al. (<a href="#ref-hvarfner2022pibo" role="doc-biblioref">2022</a>)</span>. <span class="citation" data-cites="hvarfner2022pibo">(<a href="#ref-hvarfner2022pibo" role="doc-biblioref">Hvarfner et al. 2022</a>)</span> and <span class="citation" data-cites="Ramachandran2020">(<a href="#ref-Ramachandran2020" role="doc-biblioref">Ramachandran et al. 2020</a>)</span> use user-defined priors to weight the acquisition function, while <span class="citation" data-cites="Liu2022">(<a href="#ref-Liu2022" role="doc-biblioref">Liu 2022</a>)</span> diminishes this weight over time. These methods are static and don’t allow real-time expert input. <span class="citation" data-cites="BOMuse">(<a href="#ref-BOMuse" role="doc-biblioref">Gupta et al. 2023</a>)</span> allows continuous expert involvement, using a linear Gaussian process to approximate human intuition, achieving sub-linear regret bounds. <span class="citation" data-cites="av2022human">(<a href="#ref-av2022human" role="doc-biblioref">Kumar et al. 2022</a>)</span> and <span class="citation" data-cites="robot">(<a href="#ref-robot" role="doc-biblioref">Maus et al. 2022</a>)</span> present similar frameworks, offering alternative solutions for evaluation, with the expert making the final decision latterly in a molecular design setting.</p>
<div class="no-row-height column-margin column-container"><div id="ref-hvarfner2022pibo" class="csl-entry" role="listitem">
Hvarfner, Carl, Danny Stoll, Artur Souza, Marius Lindauer, Frank Hutter, and Luigi Nardi. 2022. <span>“<span class="nocase"><span class="math inline">\(\pi\)</span>BO: Augmenting Acquisition Functions with User Beliefs for Bayesian Optimization</span>.”</span> <a href="https://arxiv.org/abs/2204.11051">https://arxiv.org/abs/2204.11051</a>.
</div><div id="ref-Ramachandran2020" class="csl-entry" role="listitem">
Ramachandran, Anil, Sunil Gupta, Santu Rana, Cheng Li, and Svetha Venkatesh. 2020. <span>“<span class="nocase">Incorporating expert prior in Bayesian optimisation via space warping</span>.”</span> <em>Knowl. Based Syst.</em> 195 (May): 105663. <a href="https://doi.org/10.1016/j.knosys.2020.105663">https://doi.org/10.1016/j.knosys.2020.105663</a>.
</div><div id="ref-Liu2022" class="csl-entry" role="listitem">
Liu, Peng. 2022. <span>“<span class="nocase">Human-in-the-loop Bayesian Optimization with No-Regret Guarantees</span>,”</span> October.
</div><div id="ref-BOMuse" class="csl-entry" role="listitem">
Gupta, Sunil, Alistair Shilton, Arun Kumar A, Shannon Ryan, Majid Abdolshah, Hung Le, Santu Rana, Julian Berk, Mahad Rashid, and Svetha Venkatesh. 2023. <span>“<span class="nocase">BO-Muse: A human expert and AI teaming framework for accelerated experimental design</span>.”</span> <a href="https://doi.org/10.48550/ARXIV.2303.01684">https://doi.org/10.48550/ARXIV.2303.01684</a>.
</div><div id="ref-av2022human" class="csl-entry" role="listitem">
Kumar, A V, Arun, Santu Rana, Alistair Shilton, and Svetha Venkatesh. 2022. <span>“<span>Human-AI Collaborative Bayesian Optimisation</span>.”</span> <em>Advances in Neural Information Processing Systems</em> 35: 16233–45.
</div></div></section>
<section id="method" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="method"><span class="header-section-number">3</span> Method</h2>
<p>We first maximise a given utility function <span class="math inline">\(\mathcal{U}\)</span> for a given dataset <span class="math inline">\(\mathcal{D}_t:= \{(\mathbf{x}_i,y_i)\}_{i=1}^t\)</span>:</p>
<div class="hidden">
<p><span class="math display">\[
\DeclareMathOperator*{\argmax}{arg\,max}
\usepackage{amsmath,amsfonts,amssymb,algorithm,algorithmic}
\]</span></p>
</div>
<p><span id="eq-standard-bo"><span class="math display">\[
   \mathbf{x}^* = \argmax_{x\in\mathcal{X}\subseteq\mathbb{R}^n} \; \mathcal{U}(x),
\tag{1}\]</span></span></p>
<p>resulting in the optimal next evaluation, <span class="math inline">\(\mathbf{x}^*\)</span>, in a utility sense. Let <span class="math inline">\(p\)</span> be the number of alternate solutions provided to the expert and construct the decision variable matrix <span class="math inline">\(\mathbf{X} \in \mathbb{R}^{(p-1)\times n}\)</span> by concatenating <span class="math inline">\(p-1\)</span> alternate solutions <span class="math inline">\(\mathbf{X} := [\mathbf{x}_1,\dots,\mathbf{x}_{p-1}]\)</span>. We then define the high-throughput (batch) utility function <span class="math inline">\(\hat{\mathcal{U}}\)</span> which is specified as the sum of the individual utilities of alternate solutions within <span class="math inline">\(\mathbf{X}\)</span></p>
<p><span class="math display">\[\begin{align}
    \hat{\mathcal{U}}(\mathbf{X}) = \sum_{i=0}^{p-1} \mathcal{U}(\mathbf{X}_i).
\end{align}\]</span> Similarly, we introduce <span class="math inline">\(\hat{\mathcal{S}}\)</span> as a measure for capturing the variability among both the optimal and alternative solutions. Specifically, let <span class="math inline">\(\hat{\mathcal{S}}\)</span> be the determinant of the covariance matrix <span class="math inline">\(K_{\mathbf{X}_{\text{aug}}}\)</span> for the augmented set <span class="math inline">\(\mathbf{X}_{\text{aug}}= \mathbf{X} \cup \mathbf{x}^*\)</span>: <span class="math display">\[\begin{align*}
\hat{\mathcal{S}}(\mathbf{X},\mathbf{x}^*) &amp;= |K_{\mathbf{X_{\text{aug}}}}| \\
K_{\mathbf{X}_{\text{aug}}} &amp;= [k(\mathbf{X}_{\text{aug},i},\mathbf{X}_{\text{aug},j})]^p_{i,j=1}
\end{align*}\]</span> <span class="math inline">\(\hat{\mathcal{S}}\)</span> quantifies the ‘volume of information’ spanned by the alternative solutions <span class="math inline">\(\mathbf{X}\)</span> as well as the optimal solution <span class="math inline">\(\mathbf{x}^*\)</span>. Maximising <span class="math inline">\(\hat{\mathcal{U}}\)</span> will result in all alternative solutions proposed being the same as <span class="math inline">\(\mathbf{x}^*\)</span>, that is <span class="math inline">\([\mathbf{x}^*_1,\dots,\mathbf{x}^*_{p-1}]\)</span>. Contrary to this, maximising <span class="math inline">\(\hat{\mathcal{S}}\)</span> will result in a set of solutions that are maximally-spaced both with respect to other alternatives, but also <span class="math inline">\(\mathbf{x}^*\)</span>. At iteration <span class="math inline">\(t\)</span>, we then solve the following multi-objective optimisation problem: <span class="math display">\[\begin{align}\label{multi-objective}
    [\mathbf{X}^*_1,\dots,\mathbf{X}^*_m] = \max_{\mathbf{X}} \; \left(\hat{\mathcal{U}}(\mathbf{X};\mathcal{D}_t),\hat{\mathcal{S}}(\mathbf{X},\mathbf{x}^*)\right),
\end{align}\]</span> resulting in a set of <span class="math inline">\(m\)</span> solutions along the Pareto front of both objectives. From this we define <span class="math inline">\(\mathbf{X}^*_{k}\)</span> as the solution at knee-point of the Pareto front. The <span class="math inline">\(p-1\)</span> solutions contained within <span class="math inline">\(\mathbf{X}^*_k\)</span> optimally trade off the sum of their utility values, with their variability. This ensures that when provided to an expert, alongside <span class="math inline">\(\mathbf{x}^*\)</span>, any individual solution will have high expected information gain, and the solutions themselves will be distinct enough to ensure the expert isn’t made to make an effective gradient calculation.<br>
The practitioner is then made to choose a solution to evaluate from this set of alternatives. To do so, they are provided with information such as the utility value of each solution, expected output distributions (obtained from the Gaussian process), and information regarding previous solutions that they may wish to draw upon. In doing so, the practitioner effectively performs an internal discrete Bayesian reasoning, conditioning previous prior information and expert opinion with the mathematical quantities provided to make an informed decision. Our algorithm can be located within the Appendix.</p>
<p><a href="#fig-behav">Figure&nbsp;2</a> demonstrates the intended behaviour of our approach. We present a one-dimensional case study, optimising a function obtained through sampling a Gaussian process prior, specified by a Matern 5/2 kernel with lengthscale <span class="math inline">\(l=0.5\)</span>. In this case study we provide 3 alternatives to an expert, who’s choice we select randomly. We provide details of optimisation methods and hyper-parameters within the Appendix.</p>
<div id="fig-behav" class="quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 100.0%;justify-content: center;">
<div id="fig-util" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="utility.png" class="img-fluid figure-img" data-ref-parent="fig-behav"></p>
<figcaption class="figure-caption">(a) The objective function and utility function after 6 function evaluations. The 3 alternative solutions that maximise the solution distance can be seen in red, whilst the black solutions denote those contained within the knee-solution of the high-throughput multi-objective problem. The yellow optimal solution is included alongside these two alternatives to an expert. In this case choice 4 is selected randomly from the 3 alternatives and the optimum.</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 100.0%;justify-content: center;">
<div id="fig-choices" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="choices.png" class="img-fluid figure-img" data-ref-parent="fig-behav"></p>
<figcaption class="figure-caption">(b) The information provided to the expert regarding the three alternative solutions. In this case choice 1 and choice 3 have relatively similar utility values and predicted output distributions to choice 4 (the optimal of the acquisition function). The expert is then allowed to distinguish between these similar solutions in a way the computer cannot through their prior domain knowledge. By conditioning their prior information on the given values, the expert is effectively performing internal Bayesian reasoning.</figcaption>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;2: A standard iteration of our approach on a one-dimensional case-study.</figcaption><p></p>
</figure>
</div>
</section>
<section id="computational-results-discussion" class="level2 page-columns page-full" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="computational-results-discussion"><span class="header-section-number">4</span> Computational Results &amp; Discussion</h2>
<p>To assess our approach, we benchmark it against standard Bayesian optimisation. In order to incorporate and assess human interaction in an automated manner, we hypothesise a number of different human behaviours. The ‘Expert’ practitioner represents an ideal, where the best solution (that is the one with the highest true objective value) is always selected. Equivalently, to test the performance of our approach under the influence of a practitioner with misaligned knowledge, we present an ‘Adversarial’ practitioner who consistently selects the solution with the lowest true objective value. In addition, we present a probabilistic practitioner, who selects the solution with the best true objective value with some probability. Finally, we present the behaviour of a ‘Trusting’ practitioner who selects the solution with the largest utility (as these values are presented), equivalent to standard Bayesian optimisation as this solution is obtained through standard single objective optimisation (<a href="#eq-standard-bo">Equation&nbsp;1</a>). In practice, the expert will condition the information provided with their prior beliefs. In our approach this includes information regarding the expected distribution of the objective of each solution, as well as the utility value of each solution. Whilst we cannot benchmark real human behaviour due to the random nature of the objective functions, and practical issues, the behaviours described summarise key aspects in order to generate useful insights into our approach, we leave this for future work. The human behaviours applied are summarised within <a href="#tbl-behav">Table&nbsp;1</a>.</p>
<div id="tbl-behav" class="anchored">
<table class="table">
<caption>Table&nbsp;1: Human Behaviours Applied for Benchmarking</caption>
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Behaviour Type</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Expert</td>
<td>Selects the solution with the best true function value.</td>
</tr>
<tr class="even">
<td>Adversarial</td>
<td>Selects the solution with the worst true function value.</td>
</tr>
<tr class="odd">
<td>Trusting</td>
<td>Selects the solution with the maximum utility value.</td>
</tr>
<tr class="even">
<td>p(Best)</td>
<td>Selects the solution with the best true function value with probability p(Best), otherwise selects a random solution.</td>
</tr>
</tbody>
</table>
</div>
<p>We perform optimisation over 50 functions, each representing a sample from a Gaussian process prior with lengthscale 0.3 using the upper-confidence bound (UCB) utility function. <a href="#fig-res">Figure&nbsp;3</a> demonstrates the average and standard deviation of simple regret, and average regret (both defined within <span class="citation" data-cites="Garnett2023">Garnett (<a href="#ref-Garnett2023" role="doc-biblioref">2023</a>)</span>) for each human behaviour across 1D and 2D objective functions.<br>
Results for 5D, and specific functions can be located within the Appendix.</p>
<div class="no-row-height column-margin column-container"><div id="ref-Garnett2023" class="csl-entry" role="listitem">
Garnett, Roman. 2023. <em><span>Bayesian Optimization</span></em>. Cambridge University Press. <a href="https://doi.org/10.1017/9781108348973">https://doi.org/10.1017/9781108348973</a>.
</div></div><div id="fig-res" class="quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 100.0%;justify-content: center;">
<div id="fig-1D" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="overall_regret_aq_UCB_d_1.png" class="img-fluid figure-img" data-ref-parent="fig-res"></p>
<figcaption class="figure-caption">(a) Average regret quantities over 1D objective functions.</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 100.0%;justify-content: center;">
<div id="fig-2D" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="overall_regret_aq_UCB_d_2.png" class="img-fluid figure-img" data-ref-parent="fig-res"></p>
<figcaption class="figure-caption">(b) Average regret quantities over 2D objective functions.</figcaption>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;3: Regret expectation over 50 functions, <span class="math inline">\(f \sim \mathcal{GP}(\mu \equiv 0, K_M (d,\nu = 0.3))\)</span> where <span class="math inline">\(K_M\)</span> is the Mat'ern 5/2 kernel function. 4 alternate choices are presented to the practitioner, and the utility function <span class="math inline">\(\mathcal{U}(x)\)</span> used is the upper-confidence bound.</figcaption><p></p>
</figure>
</div>
<p>The expectation of average regret tends towards zero for all behaviours, indicating empirical convergence. Focusing on results from the set of 1D functions, an ‘Expert’ provides improved convergence than standard Bayesian optimisation (‘Trusting’) throughout all iterations, with benefits diminishing throughout the later stages, where the standard automated approach recovers the ‘Expert’ average regret value, confirming previous observations regarding the importance of human input throughout earlier iterations, and conversely diminishing importance of expert opinion during `fine-tuning’ <span class="citation" data-cites="Kanarik2023">Kanarik et al. (<a href="#ref-Kanarik2023" role="doc-biblioref">2023</a>)</span>. Improved convergence of simple regret occurs in cases where the practitioner selects the ‘best’ solution from a set 75%, 50%, and to a lesser extent 25% of the time out of 4 available choices, similarly reflected in trends across average regret. The results demonstrated in <a href="#fig-res">Figure&nbsp;3</a> indicate the potential for our approach to improve the convergence of Bayesian optimisation even in cases where the practitioner is correct about a decision only partially. When the expert makes a random selection (<span class="math inline">\(p(\text{Best}) = 0.25\)</span>, for 4 alternate solutions), standard Bayesian optimisation convergence is recovered, indicating the effectiveness of the choices presented by asking a practitioner to select between distinct solutions, each of which individually has a high utility value. This is reflected throughout 1D, 2D and 5D functions. Only in the case where the practitioner actively selects the worst solution (i.e.&nbsp;they are misaligned), is performance worse. In higher-dimensions an adversarial practitioner performs worse, as they are performing inefficient space-filling in an increasingly larger volume before good solutions are found.</p>
<div class="no-row-height column-margin column-container"><div id="ref-Kanarik2023" class="csl-entry" role="listitem">
Kanarik, Keren J., Wojciech T. Osowiecki, Yu Lu, Dipongkar Talukder, Niklas Roschewsky, Sae Na Park, Mattan Kamon, David M. Fried, and Richard A. Gottscho. 2023. <span>“<span class="nocase">Human-machine collaboration for improving semiconductor process development</span>.”</span> <em>Nature</em> 616 (7958): 707–11. <a href="https://doi.org/10.1038/s41586-023-05773-7">https://doi.org/10.1038/s41586-023-05773-7</a>.
</div><div id="ref-local_pen" class="csl-entry" role="listitem">
González, Javier, Zhenwen Dai, Philipp Hennig, and Neil D. Lawrence. 2015. <span>“<span class="nocase">Batch Bayesian Optimization via Local Penalization</span>.”</span> <a href="https://doi.org/10.48550/ARXIV.1505.08052">https://doi.org/10.48550/ARXIV.1505.08052</a>.
</div><div id="ref-Bischl2014" class="csl-entry" role="listitem">
Bischl, Bernd, Simon Wessing, Nadja Bauer, Klaus Friedrichs, and Claus Weihs. 2014. <span>“<span class="nocase"><span>MOI</span>-<span>MBO</span>: Multiobjective Infill for Parallel Model-Based Optimization</span>.”</span> In <em>Lecture Notes in Computer Science</em>, 173–86. Springer International Publishing. <a href="https://doi.org/10.1007/978-3-319-09584-4_17">https://doi.org/10.1007/978-3-319-09584-4_17</a>.
</div><div id="ref-Habib2016" class="csl-entry" role="listitem">
Habib, Ahsanul, Hemant Kumar Singh, and Tapabrata Ray. 2016. <span>“<span class="nocase">A multi-objective batch infill strategy for efficient global optimization</span>.”</span> In <em>2016 <span>IEEE</span> Congress on Evolutionary Computation (<span>CEC</span>)</em>. <span>IEEE</span>. <a href="https://doi.org/10.1109/cec.2016.7744341">https://doi.org/10.1109/cec.2016.7744341</a>.
</div><div id="ref-robot" class="csl-entry" role="listitem">
Maus, Natalie, Kaiwen Wu, David Eriksson, and Jacob Gardner. 2022. <span>“<span class="nocase">Discovering Many Diverse Solutions with Bayesian Optimization</span>.”</span> <a href="https://doi.org/10.48550/ARXIV.2210.10953">https://doi.org/10.48550/ARXIV.2210.10953</a>.
</div></div><p>The methodology we present may also be interpreted as an approach for high-throughput/batch Bayesian optimisation, with an additional preference for solutions that are well-distributed throughout the search space. Our intention for future work is to benchmark it against other existing batch Bayesian optimisation methodologies <span class="citation" data-cites="local_pen">González et al. (<a href="#ref-local_pen" role="doc-biblioref">2015</a>)</span>, including those with similar multi-objective formulations (<span class="citation" data-cites="Bischl2014">Bischl et al. (<a href="#ref-Bischl2014" role="doc-biblioref">2014</a>)</span>, <span class="citation" data-cites="Habib2016">Habib, Singh, and Ray (<a href="#ref-Habib2016" role="doc-biblioref">2016</a>)</span>, <span class="citation" data-cites="robot">Maus et al. (<a href="#ref-robot" role="doc-biblioref">2022</a>)</span>). We will also investigate to what extent large-language models can perform the selection step.</p>
</section>
<section id="appendix-a-algorithm" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="appendix-a-algorithm">Appendix A (Algorithm)</h2>
<p><a href="#thm-alg">Algorithm&nbsp;1</a> demonstrates our approach.</p>
<div id="thm-alg" class="theorem">
<p><span class="theorem-title"><strong>Algorithm 1 </strong></span><img src="algorithm.png" class="img-fluid" alt="Expert-Guided Bayesian Optimization"></p>
</div>
</section>
<section id="appendix-b-optimisation-details" class="level2 unnumbered page-columns page-full">
<h2 class="unnumbered anchored" data-anchor-id="appendix-b-optimisation-details">Appendix B (Optimisation Details)</h2>
<p>Throughout this paper we apply 4 alternative solutions at each iteration (one of which will be the optimum of the utility function). Throughout all optimisation problems we generate an initial sample of 4 experiments, distributed via a static Latin hypercube design-of-experiments. When training the Gaussian process that models the objective-space we perform a multi-start of 8 gradient-based optimisation runs using Adam with a learning rate of 1e-3 for 750 iterations to determine GP hyperparameters. To solve the multi-objective augmented optimisation problem, resulting in a Pareto set of sets of alternative solutions we run NSGA-II <span class="citation" data-cites="Deb2002">Deb et al. (<a href="#ref-Deb2002" role="doc-biblioref">2002</a>)</span> for 150 iterations, with a population size of 100, 30 offspring at each iteration, a 0.9 probability of crossover, and 20 mutations per iteration. To generate the single optimum of the acquisition function, we perform a multi-start of 36 gradient-based optimisation runs using L-BFGS-B <span class="citation" data-cites="zhu1997algorithm">Zhu et al. (<a href="#ref-zhu1997algorithm" role="doc-biblioref">1997</a>)</span> with a tolerance of 1e-12 and a maximum iterations of 500. For the 1D, 2D, and 5D expectations over functions stemming from samples of a Gaussian process prior (with lengthscale 0.3), the lower and upper bounds used are 0 and 10 respectively for each dimension. All other bounds for functions can be located at <a href="http://www.sfu.ca/~ssurjano/optimization.html">http://www.sfu.ca/~ssurjano/optimization.html</a></p>
<div class="no-row-height column-margin column-container"><div id="ref-Deb2002" class="csl-entry" role="listitem">
Deb, K., A. Pratap, S. Agarwal, and T. Meyarivan. 2002. <span>“<span class="nocase">A fast and elitist multiobjective genetic algorithm: <span>NSGA</span>-<span>II</span></span>.”</span> <em><span>IEEE</span> Transactions on Evolutionary Computation</em> 6 (2): 182–97. <a href="https://doi.org/10.1109/4235.996017">https://doi.org/10.1109/4235.996017</a>.
</div><div id="ref-zhu1997algorithm" class="csl-entry" role="listitem">
Zhu, Ciyou, Richard H Byrd, Peihuang Lu, and Jorge Nocedal. 1997. <span>“<span class="nocase">Algorithm 778: L-BFGS-B: Fortran subroutines for large-scale bound-constrained optimization</span>.”</span> <em>ACM Transactions on Mathematical Software (TOMS)</em> 23 (4): 550–60.
</div></div></section>
<section id="appendix-c.-regret-plots" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="appendix-c.-regret-plots">Appendix C. (Regret Plots)</h2>
<div id="fig-5D" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="overall_regret_aq_UCB_d_5.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;4: Regret expectation over 50 5D functions (<span class="math inline">\(d=5\)</span>), <span class="math inline">\(f \sim \mathcal{GP}(\mu \equiv 0, K_M (d,\nu = 0.3))\)</span> where <span class="math inline">\(K_M\)</span> is the Matern 5/2 kernel function. 4 alternate choices are presented to the practitioner, and the utility function <span class="math inline">\(\mathcal{U}(x)\)</span> used is the upper-confidence bound.</figcaption>
</figure>
</div>
<p>We subsequently present the expectation of regret for a number of functions across all human behaviours. We present 4 alternate choices are presented to the hypothetical practitioner, and the utility function <span class="math inline">\(\mathcal{U}(x)\)</span> used is the upper-confidence bound. Each function is optimised 16 times, across a number of random initialisations, and average regret quantities are plotted. Optimisation details are presented in the previous Appendix section.</p>
<details>
<summary>
Click to expand additional regret plots
</summary>
<div id="fig-2D-Ackley" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="overall_regret_Ackley2.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;5: 2D Ackley Function</figcaption>
</figure>
</div>
<div id="fig-5D-Ackley" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="overall_regret_Ackley5.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;6: 5D Ackley Function</figcaption>
</figure>
</div>
<div id="fig-10D-Ackley" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="overall_regret_Ackley10.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;7: 10D Ackley Function</figcaption>
</figure>
</div>
<div id="fig-2D-Griewank" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="overall_regret_Griewank2.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;8: 2D Griewank Function</figcaption>
</figure>
</div>
<div id="fig-5D-Griewank" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="overall_regret_Griewank5.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;9: 5D Griewank Function</figcaption>
</figure>
</div>
<div id="fig-10D-Griewank" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="overall_regret_Griewank10.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;10: 10D Griewank Function</figcaption>
</figure>
</div>
<div id="fig-5D-Powell" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="overall_regret_Powell5.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;11: 5D Powell Function</figcaption>
</figure>
</div>
<div id="fig-2D-Rastrigin" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="overall_regret_Rastrigin2.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;12: 2D Rastrigin Function</figcaption>
</figure>
</div>
<div id="fig-5D-Rastrigin" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="overall_regret_Rastrigin5.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;13: 5D Rastrigin Function</figcaption>
</figure>
</div>
<div id="fig-10D-Rastrigin" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="overall_regret_Rastrigin10.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;14: 10D Rastrigin Function</figcaption>
</figure>
</div>
<div id="fig-10D-Rosenbrock" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="overall_regret_Rosenbrock10.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;15: 10D Rosenbrock Function</figcaption>
</figure>
</div>
</details>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{savage2023,
  author = {Savage, Tom and del Rio Chanona, Antonio},
  title = {Expert-Guided {Bayesian} {Optimisation} for
    {Human-in-the-loop} {Experimental} {Design} of {Known} {Systems}},
  date = {2023-10-27},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-savage2023" class="csl-entry quarto-appendix-citeas" role="listitem">
Savage, Tom, and Antonio del Rio Chanona. 2023. <span>“Expert-Guided
Bayesian Optimisation for Human-in-the-Loop Experimental Design of Known
Systems.”</span> October 27, 2023.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>
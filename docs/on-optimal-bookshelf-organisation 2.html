<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.557">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Tom Savage</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Tom Savage</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">




<section id="on-optimal-bookshelf-organisation" class="level1">
<h1>On Optimal Bookshelf Organisation</h1>
<section id="taking-a-book-for-a-walk." class="level2">
<h2 class="anchored" data-anchor-id="taking-a-book-for-a-walk.">Taking a book for a walk.</h2>
<p><strong>Date not found</strong></p>
<p><strong>Likes:</strong> 0</p>
<p><a href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5e5fe15d-42a4-44ef-bd8b-0706bab98614_6600x4800.png"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5e5fe15d-42a4-44ef-bd8b-0706bab98614_6600x4800.png" class="img-fluid"></a></p>
<p>How someone organises, or chooses not to organise a bookshelf can say a lot about them. I personally don’t think there is any sense in enforcing a specific order. My strategy can be summarised as ‘vibes based’. There is joy in being able to know roughly where a book is and pick it out mid conversation. It makes me feel like I’m some sort of magician or an old librarian, holding the secret mental key that will unscramble order from chaos.</p>
<p>But, if you don’t believe in this serendipity, you might be inclined to choose <em>something</em> to base the order on. Given we are pretty good at remembering the title of a book, maybe alphabetical order is good. Actually, authors should be grouped together, so let’s make them alphabetical. What about we do that and then also group some categories of similar books together (S/O Dewey). The most intelligent of us out there may choose to forego any sense of useful meaning, and satirically choose to base the order on the colour of the cover, subverting the old book judging adage.</p>
<p><a href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Faa20e7da-8b08-4860-a3d1-bf7919b63540_1852x660.png"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Faa20e7da-8b08-4860-a3d1-bf7919b63540_1852x660.png" class="img-fluid"></a><a href="https://x.com/trussliz/status/1838101872969687143">No Comment</a></p>
<p>These approaches have been discussed at length <a href="https://www.clutter.com/blog/posts/how-to-organize-book-collection/">here</a> <a href="https://www.penguin.co.uk/articles/2022/01/bookshelf-organising-tips-books-home-library">here</a> <a href="https://www.neathousesweethome.com/aesthetic-ways-to-organize-bookshelves/">here</a> <a href="https://bookriot.com/how-to-organize-bookshelves/">here</a> and <a href="https://www.oprahdaily.com/life/g35578167/how-to-organize-bookshelves/">here</a>, you get the idea. The reason they’re up for debate is because none of them are truly <em>optimal.</em> **** None take advantage of all __ the available information… <strong>Until now.</strong> Later on in this post I will describe an optimal strategy to sorting a book collection that I’ve also made open source, but first we must collect some data.</p>
<p>Digitising all the books I own is a task low down on my todo list (compared to finishing my PhD). So to aid in this, I created a Command Line Interface (CLI) tool to help me. It’s available <a href="https://github.com/trsav/bookshelf/tree/main">here</a> and I’ve creatively named it <code>optimal-bookshelf</code>. It allows you to add books to a persistent locally-stored virtual library by searching for a title using open book APIs (i.e.&nbsp;Google Books), after which a more thorough search is performed and the specific edition can be selected. Ideally most of the information is correct at this point, but you then have the option to edit specific data such as the ISBN. I tailored this tool as I was digitising my collection, so it should be as efficient as possible on the Pareto curve of information vs time.</p>
<p>This enabled me to create an accurate digital representation of all the books I own, down to the specific edition, in a relatively short amount of time.</p>
<p><a href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F73cab761-f044-4bf1-bd93-646631e3d896_2116x1566.png"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F73cab761-f044-4bf1-bd93-646631e3d896_2116x1566.png" class="img-fluid"></a></p>
<p>But what to do with this wealth of information? Well, for now it is largely text-based. To do anything that will concern a notion optimality, we need <em>numbers</em>. It follows that we can summarise <strong>all</strong> the information that we have generated, and result in a numerical representation by creating <em>embeddings</em> of our virtualised book-twins. By tokenising the information, embeddings represent text as dense vectors in a high-dimensional space using models trained specifically for this purpose. These embedding models are designed to capture semantic relationships between words and phrases, allowing us to perform mathematical operations that measure how similar different pieces of text are to each other. In the <code>optimal-bookshelf</code> CLI, embeddings are created using OpenAI’s<code>text-embedding-3-large</code> model and can easily be generated using the <code>$ bookshelf embed</code> command.</p>
<p>If I make the assumption that I want books near each other to be semantically related (i.e.&nbsp;have a low Euclidian distance in embedding space), and that every book must appear on my bookshelf exactly once, I can equivalently formulate this task as an optimisation problem, minimising the total distance travelled by traversing from embedding to embedding. In this case I don’t mind that this trip isn’t a loop (because my bookshelf is a ‘line’ and not a circle, but this can be revisited later), resulting in a formulation of the classic integer programming <strong>no-return<a href="https://en.wikipedia.org/wiki/Travelling_salesman_problem#Special_cases">Travelling Salesmen Problem</a>. </strong>Solving this will result in a sequence of books that embodies the lowest total semantic difference between neighbouring books. It makes the <em>most sense,</em> in ways that are not just affiliated with the title or the author, or even the genre, but the fundamental <em>concept</em> of that book <em>.</em> Having generated embeddings, solving this problem is easy in <code>optimal-bookshelf</code>. Just run the command <code>bookshelf tsp.</code></p>
<p>For visualisation purposes, you can also solve a TSP over embeddings that have first been reduced to two dimensions. The easiest and generally most effective way to do this in situations where the meaning isn’t too important (<a href="https://arxiv.org/pdf/2002.06910#:~:text=Despite%20their%20usefulness%2C%20t%2DSNE,non%2Dexperts%20in%20dimensionality%20reduction.">alert they can be misleading</a>) is to use <a href="https://www.jmlr.org/papers/volume9/vandermaaten08a/vandermaaten08a.pdf">t-SNE</a>. Running <code>bookshelf tsp -v</code>(for visual) first uses t-SNE to reduce the dimension of the embeddings, and then solves the reduced dimension TSP (as the TSP relies on a distance matrix it scales with number of points and not dimensionality) resulting in the following:</p>
<p><a href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0b520655-7e2c-4e3b-bea7-adf2dd362992_6600x4800.png"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0b520655-7e2c-4e3b-bea7-adf2dd362992_6600x4800.png" class="img-fluid"></a></p>
<p>It’s really interesting to follow the path and see themes emerging based on author or publication date, or even if the book is read, unread, or in progress, though I’m choosing to keep secret and just label the titles. It all acts like a constellation of my reading interests and habits, similar to the manually created constellation of artists at the Tate Liverpool.</p>
<p><a href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6df08cd1-12f3-4385-8e2e-72244078c7cd_1024x694.jpeg"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6df08cd1-12f3-4385-8e2e-72244078c7cd_1024x694.jpeg" class="img-fluid" alt="Tate Liverpool on X: “Two new Constellations open tomorrow… https://t.co/3R7gUgJh44 #FREE https://t.co/pH0SGtaS8j” / X"></a><a href="https://www.tate.org.uk/visit/tate-liverpool/display/constellations">Tate Liverpool Constellations</a></p>
<p>I think an interesting extension would be to specify a certain number of shelves, then solve the TSP for a corresponding number of lines equal to the available shelves. In theory I have the number of pages in each book available, so I could add a physical packing constraint here to ensure all the books fit. For full transparency, here’s my current optimal shelf based on this semantic TSP. Spot the various threads that emerge…</p>
<pre><code>1. GRAVITY'S RAINBOW
2. THE MASTERS
3. THE BOOKS OF JACOB
4. FLIGHTS
5. DRIVE YOUR PLOW OVER THE BONES OF THE DEAD.
6. THE PLAGUE
7. PANDAEMONIUM 1660–1886
8. UTOPIA
9. POLITICS ON THE EDGE
10. THE RESTLESS REPUBLIC: BRITAIN WITHOUT A CROWN
11. 1599: A YEAR IN THE LIFE OF WILLIAM SHAKESPEARE
12. WILLIAM SHAKESPEARE POETRY
13. OEDIPUS AT KOLONOS
14. THE ODYSSEY: TRANSLATED BY EMILY WILSON
15. THE ILIAD: TRANSLATED BY EMILY WILSON
16. THE DIVINE COMEDY
17. DON QUIXOTE
18. THE THREE MUSKETEERS
19. THE COUNT OF MONTE CRISTO
20. CRIME AND PUNISHMENT
21. THE KARAMAZOV BROTHERS
22. THE IDIOT
23. HUMAN, ALL TOO HUMAN &amp; BEYOND GOOD AND EVIL
24. THE EMANCIPATION PROCLAMATION
25. THINK AND GROW RICH
26. TALKING TO STRANGERS
27. ESCAPE FROM MODEL LAND
28. VALUES
29. DOMINION
30. JERUSALEM
31. THE WORLD OF STONEHENGE
32. GOING TO CHURCH IN MEDIEVAL ENGLAND
33. THE RUIN OF ALL WITCHES
34. MIDNIGHT IN CHERNOBYL
35. ABYSS: THE CUBAN MISSILE CRISIS 1962
36. SECRET WARS
37. DIVIDED HOUSES: THE HUNDRED YEARS WAR III
38. TRIAL BY BATTLE: THE HUNDRED YEARS WAR I
39. TRIAL BY FIRE: THE HUNDRED YEARS WAR II
40. HIGH PERFORMANCE ROWING
41. WRITING ABOUT SPORT
42. GAZZA AGONISTES
43. THE LAST LEONARDO
44. THE CREATIVE ACT
45. ON ART AND LIFE
46. STORY OF ART
47. THE PENGUIN BOOK OF CLASSICAL MYTHS
48. VENI, VIDI, VICI
49. THE TWELVE CAESARS
50. THE HISTORY OF THE DECLINE AND FALL OF THE ROMAN EMPIRE: ABRIDGED EDITION
51. PAX
52. ASTERIX: ASTERIX AND THE WHITE IRIS
53. SUPER-INFINITE
54. SYSTEMS FOR...
55. MOBILE MANIA
56. THE ICON CATALOGUE UK GARAGE VOL. 1
57. LONDON FEEDS ITSELF
58. LONDON FIELDS
59. DAMASCUS STATION
60. MOSCOW X
61. A PERFECT SPY
62. THE SPY AND THE TRAITOR
63. BEHIND THE ENIGMA
64. THE MERCENARY RIVER
65. THE LADYBIRD BOOK OF THE HANGOVER
66. STIG OF THE DUMP
67. THE TALES OF BEEDLE THE BARD
68. HARRY POTTER AND THE HALF-BLOOD PRINCE
69. JOURNEY TO THE CENTRE OF THE EARTH
70. DR JEKYLL AND MR HYDE
71. TREASURE ISLAND
72. TOM SAWYER &amp; HUCKLEBERRY FINN
73. THE ADVENTURES AND MEMOIRS OF SHERLOCK HOLMES
74. THE RETURN OF SHERLOCK HOLMES
75. MACHINES OF LOVING GRACE
76. PROCESS DYNAMICS AND CONTROL
77. GAUSSIAN PROCESSES FOR MACHINE LEARNING
78. BAYESIAN OPTIMIZATION
79. NUMERICAL OPTIMIZATION
80. ROBUST OPTIMIZATION
81. FOUNDATIONS OF APPLIED MATHEMATICS, VOLUME 2
82. FOUNDATIONS OF APPLIED MATHEMATICS, VOLUME I
83. HOW TO PROVE IT
84. INTRODUCING LOGIC
85. INTRODUCING QUANTUM THEORY
86. INTRODUCING CHAOS
87. INTRODUCING FRACTALS
88. INTRODUCING INFINITY
89. OUR MATHEMATICAL UNIVERSE
90. COLLINS DICTIONARY OF MATHEMATICS
91. FOUR COLORS SUFFICE
92. RINGWORLD
93. THE LORD OF THE RINGS
94. THE HOBBIT
95. CLOUD ATLAS
96. A SUPPOSEDLY FUN THING I'LL NEVER DO AGAIN
97. INFINITE JEST
98. AMERICAN PSYCHO
99. BRING UP THE BODIES
100. THE NATION KILLERS
101. BURY MY HEART AT WOUNDED KNEE
102. STALINGRAD
103. WAR AND PEACE
104. NAPOLEON IN EGYPT
105. GREECE
106. ATHENS
107. DEMOCRACY'S BEGINNING
108. THE BATTLE FOR THE ARAB SPRING
109. MIKE CONTRE-ATTAQUE!
110. KISSINGER
111. THE ESCAPE ARTIST
112. 1000 YEARS OF JOYS AND SORROWS
113. LUCKY KUNST
114. MURDER ON THE DARTS BOARD
115. GONE FISHING
116. THE SATSUMA COMPLEX
117. THAT’S YOUR LOT
118. MARCH OF THE LEMMINGS
119. HOUSE ARREST
120. COMING HOME
121. NO TURNING BACK
122. KILLING THATCHER: THE IRA, THE MANHUNT AND THE LONG WAR ON THE CROWN
123. SAY NOTHING: A TRUE STORY OF MURDER AND MEMORY IN NORTHERN IRELAND
124. FALL
125. ONE TWO THREE FOUR: THE BEATLES IN TIME
126. K-PUNK
127. DEATH AND THE PENGUIN
128. MURDLE
129. THE HARD-BOILED WONDERLAND AND THE END OF THE WORLD
130. ON THE ROAD
131. A MOVEABLE FEAST
132. FLAUBERT'S PARROT
133. NINETEEN EIGHTY-FOUR
134. TENDER IS THE NIGHT
135. THE UNBEARABLE LIGHTNESS OF BEING
136. SLAUGHTERHOUSE-FIVE
137. CATCH-22
138. WE ALWAYS TREAT WOMEN TOO WELL</code></pre>
<p>I think another next logical step would be to build in a recommendation tool based on the vector embeddings and maybe even the resulting TSP solutions. This would potentially result in a bi-level integer program (hard) depending on what you deem most important (add a book that would fit most optimally within a current collection of books, or add a book that would result in the most added distance to the resulting optimal semantic tour?), but with a small enough number candidates this could be solved without approximation. We will see.</p>
<p>Was it worth it? Perhaps the lesson in all of this is that fulfilment lies not in choosing between chaos and order, but in finding systems that embrace both—straddling each paradigm, allowing us to be both the organised librarian and to take a book for a walk.</p>
<p><a href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f35e33e-9eb5-49af-9fc0-15e8370562a8_1400x924.jpeg"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f35e33e-9eb5-49af-9fc0-15e8370562a8_1400x924.jpeg" class="img-fluid" alt="Why Paul Klee’s Art is an Ingenious Blend of Process and Imagination | by Christopher P Jones | Medium"></a>Paul Klee.</p>
<p>As I’ve quoted before, Donella Meadows states in her book <em>Thinking in Systems: A Primer:</em></p>
<blockquote class="blockquote">
<p>There is yet one leverage point that is even higher than changing a paradigm. That is to keep oneself unattached in the arena of paradigms, to stay flexible, to realize that no paradigm is “true”, that every one, including the one that sweetly shapes your own worldview, is a tremendously limited understanding of an immense and amazing universe that is far beyond human comprehension.</p>
</blockquote>
<p>All code for this post can be found here: <a href="https://github.com/trsav/bookshelf" class="uri">https://github.com/trsav/bookshelf</a></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/sav\.phd");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>